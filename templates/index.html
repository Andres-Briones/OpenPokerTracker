<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Poker Hand Replayer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h2>Poker Hand Replayer</h2>
    
    <!-- File Upload Section -->
    <div id="uploadSection">
        <label for="handFile">Choose File</label>
        <input type="file" id="handFile" name="file">
        <button onclick="uploadFile()">Upload Hand File</button>
    </div>
    
    <!-- Game Info Display Section -->
    <div id="gameInfo">
        <p><strong>Round:</strong> <span id="roundDisplay">N/A</span></p>
        <p><strong>Action Description:</strong> <span id="descriptionDisplay">N/A</span></p>
        <p><strong>Pot:</strong> <span id="potDisplay">0</span></p>
        <p><strong>Board:</strong> <span id="boardDisplay">None</span></p>
        
        <!-- Player Information Table -->
        <table id="playersTable">
            <thead>
                <tr>
                    <th>Player Name</th>
                    <th>Chips</th>
                    <th>Cards</th>
                    <th>Status</th>
                    <th>Bet</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Final Pot Information -->
        <div id="potInfo" style="display: none;">
            <h3>Final Pot Information</h3>
            <p class="pot-summary">Total Pot: <span id="totalPotDisplay"></span> | Rake: <span id="rakeDisplay"></span></p>
            <table>
                <thead>
                    <tr>
                        <th>Winner</th>
                        <th>Win Amount</th>
                        <th>Cashout Fee</th>
                        <th>Cashout Amount</th>
                    </tr>
                </thead>
                <tbody id="potWinnersTable"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
        <button onclick="prevAction()">Previous</button>
        <button onclick="nextAction()">Next</button>
    </div>

    <script>
        let gameStateTable = [];
        let currentActionIndex = 0;
        let potInfo = null;

        async function uploadFile() {
            const fileInput = document.getElementById('handFile');
            if (!fileInput.files.length) {
                alert("Please select a file first.");
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.message === "File uploaded successfully") {
                    gameStateTable = data.game_state_table;
                    potInfo = data.pot_info;
                    currentActionIndex = 0;
                    displayAction(gameStateTable[currentActionIndex]);
                } else {
                    alert("Error uploading file: " + data.error);
                }
            } catch (error) {
                console.error("Upload failed:", error);
            }
        }

        function displayAction(action) {
            if (!action) return;

            document.getElementById('roundDisplay').textContent = action.round;
            document.getElementById('potDisplay').textContent = action.pot.toFixed(2);
            document.getElementById('boardDisplay').textContent = action.board.join(", ") || "None";
            document.getElementById('descriptionDisplay').textContent = action.description;

            const playersTableBody = document.querySelector("#playersTable tbody");
            playersTableBody.innerHTML = '';  // Clear previous rows

            action.players.forEach(player => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${player.name}</td>
                    <td>${player.chips.toFixed(2)}</td>
                    <td>${player.cards}</td>
                    <td>${player.status === "Folded" ? '' : player.status}</td> <!-- Hide status if folded -->
                    <td>${player.actual_bet ? player.actual_bet.toFixed(2) : ''}</td> <!-- Hide zero bets -->
                `;
                playersTableBody.appendChild(row);
            });

            // Display pot info if itâ€™s the final action
            if (currentActionIndex === gameStateTable.length - 1 && potInfo) {
                displayPotInfo();
            } else {
                document.getElementById('potInfo').style.display = 'none';
            }
        }

        function displayPotInfo() {
            document.getElementById('potInfo').style.display = 'block';
            const totalPot = potInfo[0].amount || 0;
            const rake = potInfo[0].rake || 0;

            document.getElementById('totalPotDisplay').textContent = totalPot.toFixed(2);
            document.getElementById('rakeDisplay').textContent = rake.toFixed(2);

            const potWinnersTableBody = document.getElementById('potWinnersTable');
            potWinnersTableBody.innerHTML = '';
            potInfo[0].player_wins.forEach(winner => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${winner.name}</td>
                    <td>${winner.win_amount.toFixed(2)}</td>
                    <td>${winner.cashout_fee.toFixed(2)}</td>
                    <td>${winner.cashout_amount.toFixed(2)}</td>
                `;
                potWinnersTableBody.appendChild(row);
            });
        }

        async function nextAction() {
            if (currentActionIndex < gameStateTable.length - 1) {
                currentActionIndex++;
                displayAction(gameStateTable[currentActionIndex]);
            } else {
                alert("No more actions.");
            }
        }

        async function prevAction() {
            if (currentActionIndex > 0) {
                currentActionIndex--;
                displayAction(gameStateTable[currentActionIndex]);
            } else {
                alert("This is the first action.");
            }
        }
    </script>
</body>
</html>

